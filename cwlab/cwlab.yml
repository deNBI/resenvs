- name: Disable periodic updates
  block:
    - name: Disable unattended upgrades
      ansible.builtin.lineinfile:
        path: /etc/apt/apt.conf.d/10periodic
        regexp: "^APT::Periodic::Unattended-Upgrade"
        line: 'APT::Periodic::Unattended-Upgrade "0";'
        create: true
    - name: Stop apt-daily.* systemd services
      service:
        name: "{{ item }}"
        state: stopped
      with_items:
        - unattended-upgrades
        - apt-daily
        - apt-daily.timer
        - apt-daily-upgrade
        - apt-daily-upgrade.timer
  when: cwlab_vars.create_only_backend == "false"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: cwlab_vars.create_only_backend == "false"

- name: Wait for automatic system updates 1
  shell: while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 1; done;
  when: cwlab_vars.create_only_backend == "false"

- name: Wait for automatic system updates 2
  shell: while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 1; done;
  when: cwlab_vars.create_only_backend == "false"

- name: Generate distribution information
  ansibile.builtin.command:: lsb_release -cs
  register: release

- name: Install python3-pip
  ansible.builtin.apt:
    state: present
    name: python3-pip
  when: cwlab_vars.create_only_backend == "false"

- name: install the package, force upgrade
  pip:
    name: pip
    executable: pip3
    state: present
  when: cwlab_vars.create_only_backend == "false"


- name: Add Docker GPG apt Key
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
    state: present
  when: cwlab_vars.create_only_backend == "false"

- name: Add Docker Repository
  apt_repository:
    repo: "deb https://download.docker.com/linux/ubuntu {{ release.stdout }} stable"
    state: present
  when: cwlab_vars.create_only_backend == "false"

- name: Update apt and install docker-ce
  ansible.builtin.apt: update_cache=yes name=docker-ce state=latest
  when: cwlab_vars.create_only_backend == "false"

- name: Install Docker Module for Python
  pip:
    name: docker
  when: cwlab_vars.create_only_backend == "false"

- name: Install Docker Compose Module for Python
  pip:
    name: docker-compose
  when: cwlab_vars.create_only_backend == "false"

- name: Add ubuntu user to docker group
  ansible.builtin.user:
    name: ubuntu
    groups: docker
    append: true
  become: true
  when: cwlab_vars.create_only_backend == "false"

- name: Install docker python dev package
  ansible.builtin.apt:
    name: python3-docker
  become: true
  when: cwlab_vars.create_only_backend == "false"

- name: Ensure data path exists
  ansible.builtin.file:
    state: directory
    path: "{{ cwlab_vars.data_volume_path }}"
    recurse: true
    owner: ubuntu
    group: ubuntu
  when: cwlab_vars.create_only_backend == "false"

- name: Launch cwlab container
  community.general.docker_container:
    name: cwlab
    image: "{{ cwlab_vars.image }}"
    ports:
      - "{{ cwlab_vars.exposed_port }}:5000"
    volumes:
      - "{{ cwlab_vars.data_volume_path }}:/cwlab"
    restart_policy: always
    user: 1000:1000
    recreate: true
    privileged: true
    working_dir: "/cwlab"
    container_default_behavior: no_defaults
  when: cwlab_vars.create_only_backend == "false"

- name: Enable periodic updates
  block:
    - name: enable unattended upgrades
      ansible.builtin.lineinfile:
        path: /etc/apt/apt.conf.d/10periodic
        regexp: "^APT::Periodic::Unattended-Upgrade"
        line: 'APT::Periodic::Unattended-Upgrade "1";'
        create: true
    - name: Start apt-daily.* systemd services
      service:
        name: "{{ item }}"
        state: started
      with_items:
        - unattended-upgrades
        - apt-daily
        - apt-daily.timer
        # - apt-daily-upgrade
      #  - apt-daily-upgrade.timer
  when: cwlab_vars.create_only_backend == "false"

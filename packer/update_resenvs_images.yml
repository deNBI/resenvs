---
- name: Update ResEnv image
  hosts: localhost
  vars:
    resenv: cwlab
    location: bielefeld
    upload_environment: staging
  vars_files:
    - tags.json
    - networks.json

  tasks:
    - name: Set Update Fact to false
      ansible.builtin.set_fact:
        update: false

    - name: Retrieve list of all images
      openstack.cloud.image_info:
      register: images

    - name: Set Base Images
      ansible.builtin.set_fact:
        base_images: "{{ images.openstack_image | selectattr('tags', 'search', base_image_tag) | json_query(filter) | sort(attribute='created_at') }}"
      vars:
        filter: "[?properties.os_distro=='{{ os_distro }}' && properties.os_version=='{{ os_version }}']"

    - name: Set Resens Images
      ansible.builtin.set_fact:
        resenv_images: "{{ images.openstack_image | selectattr('tags', 'search', vars[resenv + '_tag'])| json_query(filter) | sort(attribute='created_at') }}"
      vars:
        filter: "[?properties.os_distro=='{{ os_distro }}' && properties.os_version=='{{ os_version }}']"

    - name: Set Update facts
      ansible.builtin.set_fact:
        update: true
      when:
        - base_images | length > 0
        - resenv_images | length == 0 or (resenv_images | length > 0 and (base_images | last).created_at > (resenv_images | last).created_at)

    - name: Build new {{ resenv }} image - {{ os_distro }} {{ os_version }}
      ansible.builtin.command: packer build -var-file=tags.json -var 'os_distro={{ os_distro }}' -var 'os_version={{ os_version }}' -var 'network={{ vars[location
        + '_' + upload_environment] }}' ../{{resenv}}/packer_{{ vars[resenv + '_tag'] }}.json
      when: update

- name: Clean up old {{ resenv }} images
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.openstack_image | selectattr('tags', 'search', vars[resenv + '_tag']) | selectattr('image_type', '==', 'image')
        | sort(attribute='created_at') }}"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int
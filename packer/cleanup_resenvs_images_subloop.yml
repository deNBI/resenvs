---
- name: Clean up old {{ resenv }} images for Ubuntu
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.images | selectattr('tags', 'search', vars[resenv + '_tag'])
                  | selectattr('image_type', '==', 'image')
                  | selectattr('os_distro', '==', 'ubuntu')
                  | selectattr('os_version', '==', item)
                  | rejectattr('tags', 'search', 'cluster')
                  | sort(attribute='created_at') }}"
  with_items:
    - "18.04"
    - "20.04"
    - "22.04"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int

- name: Clean up old cluster {{ resenv }} images for Ubuntu
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.images | selectattr('tags', 'search', vars[resenv + '_tag'])
                  | selectattr('tags', 'search', 'cluster')
                  | selectattr('tags', 'search', 'master')
                  | selectattr('os_distro', '==', 'ubuntu')
                  | selectattr('os_version', '==', item)
                  | selectattr('image_type', '==', 'image')
                  | sort(attribute='created_at') }}"
  with_items:
    - "18.04"
    - "20.04"
    - "22.04"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int

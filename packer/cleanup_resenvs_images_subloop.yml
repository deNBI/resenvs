---
- name: Clean up old {{ resenv }} images for Ubuntu 18
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.images| selectattr('tags', 'search', vars[resenv + '_tag']) | selectattr('image_type', '==', 'image') | selectattr('os_distro', '==',\
      \ 'ubuntu') | selectattr('os_version', '==', '18.04') | rejectattr('tags', 'search', 'cluster') | sort(attribute='created_at') }}"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int

- name: Clean up old {{ resenv }} images for Ubuntu 20
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.images| selectattr('tags', 'search', vars[resenv + '_tag'])
                  | selectattr('os_distro', '==','ubuntu')
                  | selectattr('os_version', '==', '20.04')
                  | rejectattr('tags', 'search', 'cluster')
                  | map(attribute='properties')
                  | sum (start[])
                  | selectattr('image_type', '==', 'image')
                  | sort(attribute='created_at') }}"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int

- name: Clean up old {{ resenv }} images for Ubuntu 22
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.images| selectattr('tags', 'search', vars[resenv + '_tag'])
                  | selectattr('os_distro', '==', 'ubuntu')
                  | selectattr('os_version', '==', '22.04')
                  | map(attribute='properties')
                  | sum (start[])
                  | selectattr('image_type', '==', 'image')
                  | rejectattr('tags', 'search', 'cluster')
                  | sort(attribute='created_at') }}"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int

- name: Clean up old cluster {{ resenv }} images for Ubuntu 18
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.images| selectattr('tags', 'search', vars[resenv + '_tag'])
                 | selectattr('tags', 'search', 'cluster')
                 | selectattr('tags', 'search', 'master')
                 | selectattr('os_distro', '==', 'ubuntu')
                 | selectattr('os_version', '==', '18.04')
                 | map(attribute='properties')
                 | sum (start[])
                 | selectattr('image_type', '==', 'image')
                 | sort(attribute='created_at') }}"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int

- name: Clean up old cluster {{ resenv }} images for Ubuntu 20
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.images| selectattr('tags', 'search', vars[resenv + '_tag'])
                 | selectattr('tags', 'search', 'cluster')
                 | selectattr('tags', 'search', 'master')
                 | selectattr('os_distro', '==', 'ubuntu')
                 | selectattr('os_version', '==', '20.04')
                 | map(attribute='properties')
                 | sum (start[])
                 | selectattr('image_type', '==', 'image')
                 | sort(attribute='created_at') }}"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int

- name: Clean up old cluster {{ resenv }} images for Ubuntu 22
  openstack.cloud.image:
    name: "{{ item.id }}"
    state: absent
  loop: "{{ resenv_list }}"
  loop_control:
    index_var: index
  vars:
    resenv_list: "{{ images.images| selectattr('tags', 'search', vars[resenv + '_tag'])
                  | selectattr('tags', 'search', 'cluster')
                  | selectattr('tags', 'search', 'master')
                  | selectattr('os_distro', '==', 'ubuntu')
                  | selectattr('os_version', '==', '22.04')
                  | map(attribute='properties')
                  | sum (start[])
                  | selectattr('image_type', '==', 'image')
                  | sort(attribute='created_at') }}"
  when:
    - resenv_list | length > limit | int
    - index < resenv_list | length - limit | int

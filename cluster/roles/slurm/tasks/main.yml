- debug:
    msg: "[BIBIGRID] Setup Slurm"

- name: Install Slurm base packages and dependencies
  apt:
    name:
      - slurm-wlm
    state: latest


- name: SLURM configuration
  template:
    src: slurm.conf
    dest: /etc/slurm/slurm.conf
    owner: slurm
    group: root
    mode: 0444
  notify:
    - slurmctld
    - slurmd


- block:
  - name: Install Slurm database and RestAPI packages
    apt:
      name:
        - slurmdbd
        - slurmrestd
      state: latest


  - name: Generate random JWT Secret
    command:
      cmd: "dd if=/dev/random of=/etc/slurm/jwt-secret.key bs=32 count=1"
      creates: "/etc/slurm/jwt-secret.key" # only run the command when file is not present

  - name: Change file Properties of JWT Secret file
    file:
      path: /etc/slurm/jwt-secret.key
      owner: slurm
      group: slurm
      mode: 0600

  - name: Copy env file for configuration of slurmrestd
    copy:
      src: slurmrestd_default
      dest: /etc/default/slurmrestd
      owner: root
      group: root
      mode: 0644
    notify:
      - slurmdbd
      - slurmrestd

  - name: Create Service Directory
    file:
      path: /etc/systemd/system/slurmrestd.service.d
      group: root
      owner: root
      mode: 0755
      state: directory

  - name: Copy systemd Service override file
    copy:
      src: slurmrestd_override.conf
      dest: /etc/systemd/system/slurmrestd.service.d/override.conf
      mode: 0644
      owner: root
      group: root
    notify:
      - slurmrestd

  - name: start slurm explicity after all dependencies are configured
    systemd:
      name: slurmctld
      state: started

  when: "'master' in group_names"